<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Market Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-color: #1a202c;
      --card-color: #2d3748;
      --text-color: #ffffff;
      --button-color: #22c55e;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    .card {
      background-color: var(--card-color);
    }
    .button {
      background-color: var(--button-color);
    }
  </style>
</head>
<body onload="loadTheme()">

  <div class="max-w-md mx-auto mt-10 p-5 card rounded-lg shadow-lg">
    <h2 class="text-xl font-bold text-center mb-5">Stock Market Calculator</h2>

    <!-- Cash Invested field: supports shorthand and localized formatting -->
    <div class="mb-4">
      <label class="block text-sm font-medium">Cash Invested ($)</label>
      <input type="text" id="cashInvested" class="w-full p-2 mt-1 bg-gray-700 text-white border border-gray-600 rounded" 
             placeholder="Enter cash (e.g., 2M, 5B or 20000,90)" oninput="handleCashInput(this)" onblur="formatInvestedField(this)">
    </div>

    <!-- Purchase Price and Current Price fields -->
    <div class="mb-4">
      <label class="block text-sm font-medium">Purchase Price Per Share ($)</label>
      <input type="text" id="purchasePrice" class="w-full p-2 mt-1 bg-gray-700 text-white border border-gray-600 rounded" 
             placeholder="Enter purchase price">
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium">Current Price Per Share ($)</label>
      <input type="text" id="currentPrice" class="w-full p-2 mt-1 bg-gray-700 text-white border border-gray-600 rounded" 
             placeholder="Enter current price">
    </div>

    <button onclick="calculateProfit()" class="w-full button hover:opacity-80 text-white font-bold py-2 px-4 rounded">Calculate</button>

    <div class="mt-5 p-4 card rounded">
      <h3 class="text-lg font-bold">Results</h3>
      <p>Shares Owned: <span id="sharesOwned">0</span></p>
      <p>Total Value: <span id="totalValue">$0</span></p>
      <p>Profit/Loss: <span id="profitLoss" class="text-green-400">$0</span></p>
      <p>Percentage Change: <span id="percentageChange" class="text-green-400">0.00%</span></p>
    </div>
  </div>

  <script>
    // Format a number using the 'de-DE' locale (which uses dot for thousands and comma for decimals)
    function formatNumberWithDe(num) {
      return num.toLocaleString('de-DE');
    }

    // Parse the Cash Invested field value.
    function parseInvestedInput(value) {
      value = value.trim().toLowerCase();
      let multiplier = 1;

      // Handle shorthand notations (k, m, b, t)
      if (/[kmbt]$/.test(value)) {
        if (value.endsWith('m')) {
          multiplier = 1e6;
          value = value.slice(0, -1);
        } else if (value.endsWith('b')) {
          multiplier = 1e9;
          value = value.slice(0, -1);
        } else if (value.endsWith('k')) {
          multiplier = 1e3;
          value = value.slice(0, -1);
        } else if (value.endsWith('t')) {
          multiplier = 1e12;
          value = value.slice(0, -1);
        }

        // Replace any commas with dots for parsing decimals
        value = value.replace(',', '.');
        let num = parseFloat(value);
        return isNaN(num) ? 0 : num * multiplier;
      } else {
        // If no shorthand, just parse the number directly
        let normalized = value.replace(/\./g, '').replace(',', '.');
        let num = parseFloat(normalized);
        return isNaN(num) ? 0 : num;
      }
    }

    // When typing in the Cash Invested field, allow valid characters.
    function handleCashInput(input) {
      // Allow digits, comma, dot, and shorthand letters (k, m, b, t)
      input.value = input.value.replace(/[^0-9,\.kmbt]/gi, '');
    }

    // On blur, format the Cash Invested field to the desired format.
    function formatInvestedField(input) {
      let rawValue = input.value;
      if (!rawValue) return;
      
      let num = parseInvestedInput(rawValue);
      if (num === 0) return;

      // Format the number using de-DE locale (thousands separated by dot, decimals by comma)
      input.value = formatNumberWithDe(num);
    }

    // For Purchase and Current Price fields, parse standard input:
    function parseStandardInput(value) {
      value = value.trim();
      let normalized = value.replace(/\./g, '').replace(',', '.');
      return parseFloat(normalized);
    }

    function calculateProfit() {
      let cashInvestedRaw = document.getElementById('cashInvested').value;
      let purchasePriceRaw = document.getElementById('purchasePrice').value;
      let currentPriceRaw = document.getElementById('currentPrice').value;
      
      let cashInvested = parseInvestedInput(cashInvestedRaw);
      let purchasePrice = parseStandardInput(purchasePriceRaw);
      let currentPrice = parseStandardInput(currentPriceRaw);

      if (isNaN(cashInvested) || isNaN(purchasePrice) || isNaN(currentPrice) || purchasePrice <= 0) {
        alert('Please enter valid numbers');
        return;
      }

      let sharesOwned = cashInvested / purchasePrice;
      let totalValue = sharesOwned * currentPrice;
      let profitLoss = totalValue - cashInvested;
      let percentageChange = ((profitLoss / cashInvested) * 100).toFixed(2);

      document.getElementById('sharesOwned').textContent = formatNumberWithDe(sharesOwned);
      document.getElementById('totalValue').textContent = '$' + formatNumberWithDe(totalValue);
      document.getElementById('profitLoss').textContent = '$' + formatNumberWithDe(profitLoss);
      document.getElementById('profitLoss').className = profitLoss >= 0 ? 'text-green-400' : 'text-red-400';
      document.getElementById('percentageChange').textContent = percentageChange + '%';
      document.getElementById('percentageChange').className = profitLoss >= 0 ? 'text-green-400' : 'text-red-400';
    }

    function loadTheme() {
      let savedTheme = localStorage.getItem("selectedTheme");
      if (savedTheme) changeTheme(savedTheme);
    }
  </script>

</body>
</html>